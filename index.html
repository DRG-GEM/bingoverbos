<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Verbal - EdTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Changa+One&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* --- ESTILOS CARTÓN --- */
        .bingo-card-container {
            background-color: #fff;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
        }
        .bingo-header { font-family: 'Changa One', sans-serif; letter-spacing: 0.15em; }
        
        .bingo-cell {
            position: relative;
            background-color: #f1f5f9;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.1s;
        }
        .bingo-cell:active { transform: scale(0.96); }

        /* Ficha semitransparente */
        .bingo-chip {
            position: absolute;
            top: 50%; left: 50%;
            width: 80%; height: 80%;
            background-color: rgba(239, 68, 68, 0.5);
            border-radius: 50%;
            border: 4px solid rgba(220, 38, 38, 0.8);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .bingo-cell.marked .bingo-chip { transform: translate(-50%, -50%) scale(1); }

        /* --- TARJETITAS (TAGS) --- */
        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.1rem;
            margin: 0.25rem;
            box-shadow: 0 2px 0 rgba(0,0,0,0.05);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tag-person { background-color: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; }
        .tag-number { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .tag-tense  { background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        .tag-mood   { background-color: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }

        .screen-enter { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-pop { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { opacity:0; transform: scale(0.5); } 100% { opacity:1; transform: scale(1); } }

        /* Icono de voz hablando */
        .speaking { animation: pulse-voice 1s infinite; color: #4f46e5; }
        @keyframes pulse-voice { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        /* Estilos botón nivel activo */
        .btn-level.active { ring-width: 2px; ring-offset-width: 2px; transform: scale(1.02); }
        .btn-level-1.active { background-color: #dcfce7; color: #166534; border-color: #166534; ring-color: #166534; }
        .btn-level-2.active { background-color: #dbeafe; color: #1e40af; border-color: #1e40af; ring-color: #1e40af; }
        .btn-level-3.active { background-color: #f3e8ff; color: #6b21a8; border-color: #6b21a8; ring-color: #6b21a8; }
    </style>
</head>
<body class="min-h-screen text-slate-800 flex flex-col">

    <!-- HEADER -->
    <header class="bg-slate-900 text-white p-3 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
                <div class="bg-indigo-500 p-2 rounded-lg text-white"><i class="ph ph-chalkboard-teacher text-2xl"></i></div>
                <div>
                    <h1 class="text-xl font-bold leading-none tracking-tight">Bingo Gramatical</h1>
                    <span class="text-xs text-slate-400">Edición Voz</span>
                </div>
            </div>
            <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-sm transition border border-slate-700">
                <i class="ph ph-arrow-counter-clockwise"></i> Reiniciar
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 max-w-6xl">

        <!-- CONFIGURACIÓN -->
        <section id="config-screen" class="screen-enter max-w-2xl mx-auto mt-8">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                <div class="bg-indigo-600 p-6 text-white text-center">
                    <h2 class="text-3xl font-bold mb-1">Configuración</h2>
                    <p class="text-indigo-200 text-sm">Elige el modo y prepara el audio.</p>
                </div>

                <div class="p-8">
                    <!-- Modo de Juego -->
                    <div class="mb-8">
                        <label class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3 block">1. Dinámica de Juego</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Opción A -->
                            <label class="relative group cursor-pointer">
                                <input type="radio" name="gameMode" value="analyst" class="peer sr-only" checked>
                                <div class="p-4 rounded-xl border-2 border-slate-200 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition hover:border-indigo-200 h-full">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="bg-indigo-100 text-indigo-600 p-2 rounded-full"><i class="ph ph-ear text-xl"></i></div>
                                        <span class="font-bold text-slate-800">Modo Analista</span>
                                    </div>
                                    <p class="text-xs text-slate-600 leading-relaxed">
                                        Voz dice: "Primera Persona..."<br>
                                        Alumno busca: "Yo comí"
                                    </p>
                                </div>
                            </label>
                            <!-- Opción B -->
                            <label class="relative group cursor-pointer">
                                <input type="radio" name="gameMode" value="identifier" class="peer sr-only">
                                <div class="p-4 rounded-xl border-2 border-slate-200 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition hover:border-indigo-200 h-full">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="bg-indigo-100 text-indigo-600 p-2 rounded-full"><i class="ph ph-eye text-xl"></i></div>
                                        <span class="font-bold text-slate-800">Modo Identificador</span>
                                    </div>
                                    <p class="text-xs text-slate-600 leading-relaxed">
                                        Voz dice: "Yo comeré"<br>
                                        Alumno busca: "Futuro Simple"
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Niveles de Dificultad -->
                    <div class="mb-8">
                        <label class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3 block">2. Niveles de Dificultad</label>
                        
                        <!-- Botones de Nivel -->
                        <div class="flex flex-col md:flex-row gap-3 mb-4">
                            <button id="btn-lvl-1" onclick="setLevel(1)" class="btn-level btn-level-1 flex-1 py-4 px-2 rounded-xl border-2 text-sm font-bold transition transform active:scale-95 bg-white text-slate-600 border-slate-200 hover:border-green-300 flex flex-col items-center justify-center gap-1">
                                <span class="text-lg">NIVEL 1</span>
                                <span class="text-xs font-normal opacity-75 text-center leading-tight">Básico<br>(Ind. Simple)</span>
                            </button>
                            <button id="btn-lvl-2" onclick="setLevel(2)" class="btn-level btn-level-2 flex-1 py-4 px-2 rounded-xl border-2 text-sm font-bold transition transform active:scale-95 bg-white text-slate-600 border-slate-200 hover:border-blue-300 flex flex-col items-center justify-center gap-1">
                                <span class="text-lg">NIVEL 2</span>
                                <span class="text-xs font-normal opacity-75 text-center leading-tight">Medio<br>(+Compuestos)</span>
                            </button>
                            <button id="btn-lvl-3" onclick="setLevel(3)" class="btn-level btn-level-3 flex-1 py-4 px-2 rounded-xl border-2 text-sm font-bold transition transform active:scale-95 bg-white text-slate-600 border-slate-200 hover:border-purple-300 flex flex-col items-center justify-center gap-1">
                                <span class="text-lg">NIVEL 3</span>
                                <span class="text-xs font-normal opacity-75 text-center leading-tight">Experto<br>(Todo)</span>
                            </button>
                        </div>

                        <p id="error-msg" class="text-rose-500 text-sm mt-3 hidden font-bold flex items-center gap-2">
                            <i class="ph ph-warning-circle text-lg"></i> Error interno: No hay suficientes verbos.
                        </p>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-100">
                        <button onclick="startGame('teacher')" class="flex items-center justify-center gap-3 p-4 bg-slate-900 text-white rounded-xl shadow hover:bg-slate-800 transition transform active:scale-95">
                            <i class="ph ph-projector-screen-chart text-2xl"></i>
                            <div class="text-left leading-tight">
                                <span class="block font-bold">Profesor (Bombo)</span>
                            </div>
                        </button>
                        <button onclick="startGame('student')" class="flex items-center justify-center gap-3 p-4 bg-white border-2 border-slate-200 text-slate-700 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition transform active:scale-95">
                            <i class="ph ph-student text-2xl"></i>
                            <div class="text-left leading-tight">
                                <span class="block font-bold">Alumno (Cartón)</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- PANTALLA PROFESOR -->
        <section id="teacher-screen" class="hidden screen-enter h-full flex flex-col">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                
                <!-- ZONA PRINCIPAL (PROYECCIÓN) -->
                <div class="lg:col-span-8 flex flex-col gap-4">
                    <!-- Caja de la Bola -->
                    <div class="bg-white rounded-2xl shadow-xl border border-slate-200 flex flex-col relative overflow-hidden min-h-[400px]">
                        <!-- Barra superior -->
                        <div class="bg-indigo-600 h-3 w-full"></div>
                        <div class="absolute top-5 right-5 flex gap-3">
                            <button onclick="toggleVoice()" id="voice-toggle-btn" class="bg-slate-100 text-indigo-600 px-3 py-1 rounded-full text-sm font-bold border border-slate-200 flex items-center gap-2 hover:bg-slate-200">
                                <i class="ph ph-speaker-high"></i> Voz: ON
                            </button>
                            <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-sm font-bold border border-slate-200">
                                Restantes: <span id="remaining-count" class="text-indigo-600">--</span>
                            </span>
                        </div>

                        <!-- CONTENIDO CENTRAL (BOLA) -->
                        <div id="ball-display" class="flex-grow flex flex-col items-center justify-center p-8 text-center">
                            <div class="text-slate-400 flex flex-col items-center animate-pulse">
                                <i class="ph ph-play-circle text-6xl mb-4"></i>
                                <span class="text-xl font-medium">Pulsa "Sacar Bola" para comenzar</span>
                            </div>
                        </div>

                        <!-- ZONA INFERIOR (CONTROLES) -->
                        <div class="bg-slate-50 p-6 border-t border-slate-200 flex items-center justify-between gap-4">
                             <!-- Controles Izquierda -->
                            <div class="flex items-center gap-2">
                                <button onclick="toggleAnswer()" class="bg-white text-slate-400 hover:text-indigo-600 p-3 rounded-xl border border-slate-200 shadow-sm transition" title="Ver respuesta (Ojo)">
                                    <i id="eye-icon" class="ph ph-eye-slash text-2xl"></i>
                                </button>
                                <button onclick="repeatAudio()" id="repeat-btn" class="bg-white text-slate-400 hover:text-indigo-600 p-3 rounded-xl border border-slate-200 shadow-sm transition disabled:opacity-50" title="Repetir Audio" disabled>
                                    <i id="speaker-icon" class="ph ph-speaker-high text-2xl"></i>
                                </button>
                                <div id="spoiler-answer" class="ml-2 text-lg font-bold text-slate-800 opacity-0 transition-opacity select-none bg-white px-4 py-2 rounded shadow-sm border border-slate-200">
                                    ...
                                </div>
                            </div>

                            <button onclick="drawBall()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold py-4 px-10 rounded-xl shadow-lg shadow-indigo-200 transform active:translate-y-1 transition flex items-center gap-3">
                                <i class="ph ph-shuffle"></i>
                                <span>SACAR BOLA</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ZONA LATERAL (HISTORIAL) -->
                <div class="lg:col-span-4 bg-white rounded-2xl shadow-lg border border-slate-200 flex flex-col overflow-hidden max-h-[600px]">
                    <div class="bg-slate-100 p-4 font-bold text-slate-700 flex items-center justify-between border-b border-slate-200">
                        <span class="flex items-center gap-2"><i class="ph ph-clock-counter-clockwise"></i> Historial</span>
                        <span class="text-xs bg-white px-2 py-1 rounded border border-slate-200 text-slate-400 font-mono">LOG</span>
                    </div>
                    <ul id="history-list" class="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-50">
                        <!-- Items -->
                    </ul>
                </div>
            </div>
        </section>

        <!-- PANTALLA ALUMNO -->
        <section id="student-screen" class="hidden screen-enter max-w-lg mx-auto pb-12">
            
            <div class="flex items-center justify-between mb-6 px-2">
                <div>
                    <h2 class="font-bold text-slate-800 text-lg">Tu Cartón</h2>
                    <p class="text-xs text-slate-500">Escucha al profesor y marca.</p>
                </div>
                <button onclick="checkBingo()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-full font-bold shadow-lg shadow-emerald-200 transform hover:-translate-y-1 transition flex items-center gap-2">
                    <i class="ph ph-hand-waving"></i> ¡BINGO!
                </button>
            </div>

            <!-- CARTÓN -->
            <div class="bingo-card-container rounded-xl overflow-hidden transform transition-transform hover:scale-[1.01] duration-300">
                <div class="bg-indigo-600 p-4 text-center border-b-4 border-indigo-800 relative">
                    <div class="absolute top-1/2 left-4 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow-inner opacity-50"></div>
                    <div class="absolute top-1/2 right-4 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow-inner opacity-50"></div>
                    <h1 class="bingo-header text-5xl text-white drop-shadow-md">BINGO</h1>
                </div>

                <div id="bingo-grid" class="grid grid-cols-4 gap-1 p-2 bg-slate-200">
                    <!-- JS generará las celdas aquí -->
                </div>
                
                <div class="bg-slate-100 p-2 flex justify-between items-center text-[10px] text-slate-400 font-mono uppercase border-t border-slate-200">
                    <span>ID: <span id="card-id">--</span></span>
                    <span onclick="generateStudentCard()" class="cursor-pointer hover:text-indigo-500 underline decoration-dotted">Cambiar Cartón</span>
                </div>
            </div>

        </section>

    </main>

    <!-- CONFETI -->
    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

    <!-- LOGICA -->
    <script>
        // ============================================
        // 1. GENERACIÓN DE DATOS ESTRUCTURADOS
        // ============================================
        
        // Estructura Raw: [Verbo, Conjugación, Persona, Número, Tiempo, Modo, Tipo]
        const rawData = [
            // --- INDICATIVO SIMPLE ---
            ["Comer", "Yo como", "1ª", "Singular", "Presente", "Indicativo", "simple"],
            ["Vivir", "Tú vives", "2ª", "Singular", "Presente", "Indicativo", "simple"],
            ["Cantar", "Él canta", "3ª", "Singular", "Presente", "Indicativo", "simple"],
            ["Beber", "Nosotros bebemos", "1ª", "Plural", "Presente", "Indicativo", "simple"],
            ["Escribir", "Vosotros escribís", "2ª", "Plural", "Presente", "Indicativo", "simple"],
            ["Correr", "Ellos corren", "3ª", "Plural", "Presente", "Indicativo", "simple"],
            
            ["Saltar", "Yo salté", "1ª", "Singular", "Pret. Perf. Simple", "Indicativo", "simple"],
            ["Comer", "Tú comiste", "2ª", "Singular", "Pret. Perf. Simple", "Indicativo", "simple"],
            ["Salir", "Él salió", "3ª", "Singular", "Pret. Perf. Simple", "Indicativo", "simple"],
            ["Ver", "Nosotros vimos", "1ª", "Plural", "Pret. Perf. Simple", "Indicativo", "simple"],
            ["Dar", "Vosotros disteis", "2ª", "Plural", "Pret. Perf. Simple", "Indicativo", "simple"],
            ["Ir", "Ellos fueron", "3ª", "Plural", "Pret. Perf. Simple", "Indicativo", "simple"],

            ["Estar", "Yo estaba", "1ª", "Singular", "Pret. Imperfecto", "Indicativo", "simple"],
            ["Tener", "Tú tenías", "2ª", "Singular", "Pret. Imperfecto", "Indicativo", "simple"],
            ["Hacer", "Ella hacía", "3ª", "Singular", "Pret. Imperfecto", "Indicativo", "simple"],
            ["Jugar", "Nosotros jugábamos", "1ª", "Plural", "Pret. Imperfecto", "Indicativo", "simple"],
            ["Leer", "Vosotros leíais", "2ª", "Plural", "Pret. Imperfecto", "Indicativo", "simple"],
            ["Decir", "Ellos decían", "3ª", "Plural", "Pret. Imperfecto", "Indicativo", "simple"],

            ["Amar", "Yo amaré", "1ª", "Singular", "Futuro Simple", "Indicativo", "simple"],
            ["Saber", "Tú sabrás", "2ª", "Singular", "Futuro Simple", "Indicativo", "simple"],
            ["Poner", "Él pondrá", "3ª", "Singular", "Futuro Simple", "Indicativo", "simple"],
            ["Venir", "Nosotros vendremos", "1ª", "Plural", "Futuro Simple", "Indicativo", "simple"],
            ["Tener", "Vosotros tendréis", "2ª", "Plural", "Futuro Simple", "Indicativo", "simple"],
            ["Hacer", "Ellos harán", "3ª", "Plural", "Futuro Simple", "Indicativo", "simple"],

            ["Ser", "Yo sería", "1ª", "Singular", "Condicional Simple", "Indicativo", "simple"],
            ["Ir", "Tú irías", "2ª", "Singular", "Condicional Simple", "Indicativo", "simple"],
            ["Ver", "Él vería", "3ª", "Singular", "Condicional Simple", "Indicativo", "simple"],
            ["Dar", "Nosotros daríamos", "1ª", "Plural", "Condicional Simple", "Indicativo", "simple"],
            ["Saber", "Vosotros sabríais", "2ª", "Plural", "Condicional Simple", "Indicativo", "simple"],
            ["Poder", "Ellos podrían", "3ª", "Plural", "Condicional Simple", "Indicativo", "simple"],

            // --- INDICATIVO COMPUESTO ---
            ["Hablar", "Yo he hablado", "1ª", "Singular", "Pret. Perf. Compuesto", "Indicativo", "compound"],
            ["Estudiar", "Tú has estudiado", "2ª", "Singular", "Pret. Perf. Compuesto", "Indicativo", "compound"],
            ["Abrir", "Él ha abierto", "3ª", "Singular", "Pret. Perf. Compuesto", "Indicativo", "compound"],
            ["Romper", "Nosotros hemos roto", "1ª", "Plural", "Pret. Perf. Compuesto", "Indicativo", "compound"],
            ["Ver", "Ellos han visto", "3ª", "Plural", "Pret. Perf. Compuesto", "Indicativo", "compound"],
            
            ["Vivir", "Yo había vivido", "1ª", "Singular", "Pret. Pluscuamperf.", "Indicativo", "compound"],
            ["Llegar", "Tú habías llegado", "2ª", "Singular", "Pret. Pluscuamperf.", "Indicativo", "compound"],
            ["Salir", "Él había salido", "3ª", "Singular", "Pret. Pluscuamperf.", "Indicativo", "compound"],
            ["Acabar", "Nosotros habíamos acabado", "1ª", "Plural", "Pret. Pluscuamperf.", "Indicativo", "compound"],
            ["Caer", "Ellos habían caído", "3ª", "Plural", "Pret. Pluscuamperf.", "Indicativo", "compound"],
            
            ["Ganar", "Yo habré ganado", "1ª", "Singular", "Futuro Compuesto", "Indicativo", "compound"],
            ["Perder", "Tú habrás perdido", "2ª", "Singular", "Futuro Compuesto", "Indicativo", "compound"],
            ["Elegir", "Él habrá elegido", "3ª", "Singular", "Futuro Compuesto", "Indicativo", "compound"],
            ["Andar", "Nosotros habremos andado", "1ª", "Plural", "Futuro Compuesto", "Indicativo", "compound"],
            ["Dormir", "Ellos habrán dormido", "3ª", "Plural", "Futuro Compuesto", "Indicativo", "compound"],
            
            ["Estar", "Yo habría estado", "1ª", "Singular", "Condic. Compuesto", "Indicativo", "compound"],
            ["Ser", "Tú habrías sido", "2ª", "Singular", "Condic. Compuesto", "Indicativo", "compound"],
            ["Ir", "Él habría ido", "3ª", "Singular", "Condic. Compuesto", "Indicativo", "compound"],
            ["Tener", "Nosotros habríamos tenido", "1ª", "Plural", "Condic. Compuesto", "Indicativo", "compound"],
            ["Hacer", "Ellos habrían hecho", "3ª", "Plural", "Condic. Compuesto", "Indicativo", "compound"],

            // --- SUBJUNTIVO SIMPLE ---
            ["Cantar", "Yo cante", "1ª", "Singular", "Presente", "Subjuntivo", "simple"],
            ["Beber", "Tú bebas", "2ª", "Singular", "Presente", "Subjuntivo", "simple"],
            ["Vivir", "Él viva", "3ª", "Singular", "Presente", "Subjuntivo", "simple"],
            ["Tener", "Nosotros tengamos", "1ª", "Plural", "Presente", "Subjuntivo", "simple"],
            ["Salir", "Vosotros salgáis", "2ª", "Plural", "Presente", "Subjuntivo", "simple"],
            ["Poner", "Ellos pongan", "3ª", "Plural", "Presente", "Subjuntivo", "simple"],

            ["Hablar", "Yo hablara", "1ª", "Singular", "Pret. Imperfecto", "Subjuntivo", "simple"],
            ["Comer", "Tú comieras", "2ª", "Singular", "Pret. Imperfecto", "Subjuntivo", "simple"],
            ["Saber", "Él supiera", "3ª", "Singular", "Pret. Imperfecto", "Subjuntivo", "simple"],
            ["Ir", "Nosotros fuéramos", "1ª", "Plural", "Pret. Imperfecto", "Subjuntivo", "simple"],
            ["Hacer", "Vosotros hicierais", "2ª", "Plural", "Pret. Imperfecto", "Subjuntivo", "simple"],
            ["Decir", "Ellos dijeran", "3ª", "Plural", "Pret. Imperfecto", "Subjuntivo", "simple"],

            ["Estar", "Yo estuviese", "1ª", "Singular", "Pret. Imperfecto (B)", "Subjuntivo", "simple"],
            ["Ser", "Tú fueses", "2ª", "Singular", "Pret. Imperfecto (B)", "Subjuntivo", "simple"],
            ["Dar", "Él diese", "3ª", "Singular", "Pret. Imperfecto (B)", "Subjuntivo", "simple"],
            ["Ver", "Nosotros viésemos", "1ª", "Plural", "Pret. Imperfecto (B)", "Subjuntivo", "simple"],
            ["Oír", "Vosotros oyeseis", "2ª", "Plural", "Pret. Imperfecto (B)", "Subjuntivo", "simple"],
            ["Traer", "Ellos trajesen", "3ª", "Plural", "Pret. Imperfecto (B)", "Subjuntivo", "simple"],

            // --- SUBJUNTIVO COMPUESTO ---
            ["Acabar", "Yo haya acabado", "1ª", "Singular", "Pret. Perf. Compuesto", "Subjuntivo", "compound"],
            ["Empezar", "Tú hayas empezado", "2ª", "Singular", "Pret. Perf. Compuesto", "Subjuntivo", "compound"],
            ["Volver", "Él haya vuelto", "3ª", "Singular", "Pret. Perf. Compuesto", "Subjuntivo", "compound"],
            ["Ver", "Nosotros hayamos visto", "1ª", "Plural", "Pret. Perf. Compuesto", "Subjuntivo", "compound"],
            ["Abrir", "Ellos hayan abierto", "3ª", "Plural", "Pret. Perf. Compuesto", "Subjuntivo", "compound"],

            ["Llamar", "Yo hubiera llamado", "1ª", "Singular", "Pret. Pluscuamperf.", "Subjuntivo", "compound"],
            ["Sentir", "Tú hubieras sentido", "2ª", "Singular", "Pret. Pluscuamperf.", "Subjuntivo", "compound"],
            ["Pedir", "Él hubiera pedido", "3ª", "Singular", "Pret. Pluscuamperf.", "Subjuntivo", "compound"],
            ["Dormir", "Nosotros hubiéramos dormido", "1ª", "Plural", "Pret. Pluscuamperf.", "Subjuntivo", "compound"],
            ["Morir", "Ellos hubieran muerto", "3ª", "Plural", "Pret. Pluscuamperf.", "Subjuntivo", "compound"]
        ];

        const verbDatabase = rawData.map((d, i) => ({
            id: i + 1,
            infinitive: d[0],
            conjugation: d[1],
            person: d[2],
            number: d[3],
            tense: d[4],
            mood: d[5],
            type: d[6]
        }));

        // ============================================
        // 2. ESTADO
        // ============================================
        let gameState = {
            role: null,
            mode: 'analyst',
            level: 1, // Default Level
            filtered: [],
            available: [],
            currentVerb: null,
            voiceEnabled: true,
            currentSpeechText: ""
        };

        const synth = window.speechSynthesis;

        // Init Default Level
        window.onload = () => setLevel(1);

        // ============================================
        // 3. FUNCIONES DE JUEGO
        // ============================================

        function setLevel(level) {
            gameState.level = level;
            
            // Visual Updates
            document.querySelectorAll('.btn-level').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-lvl-${level}`).classList.add('active');
        }

        function startGame(role) {
            const level = gameState.level;

            // Logic without checkboxes
            const filtered = verbDatabase.filter(v => {
                if (level === 1) {
                    // Level 1: Indicative + Simple
                    return v.mood === 'Indicativo' && v.type === 'simple';
                } else if (level === 2) {
                    // Level 2: Indicative (All)
                    return v.mood === 'Indicativo';
                } else {
                    // Level 3: All (Indicative + Subjunctive)
                    return true; 
                }
            });

            if (filtered.length < 12) {
                document.getElementById('error-msg').classList.remove('hidden');
                return;
            }

            gameState.filtered = filtered;
            gameState.available = [...filtered];
            gameState.role = role;
            gameState.mode = document.querySelector('input[name="gameMode"]:checked').value;

            document.getElementById('config-screen').classList.add('hidden');
            
            if (role === 'teacher') {
                document.getElementById('teacher-screen').classList.remove('hidden');
                updateRemaining();
            } else {
                document.getElementById('student-screen').classList.remove('hidden');
                generateStudentCard();
            }
        }

        // --- PROFESOR (BOMBO) ---
        function updateRemaining() {
            document.getElementById('remaining-count').innerText = gameState.available.length;
        }

        function toggleAnswer() {
            const el = document.getElementById('spoiler-answer');
            const icon = document.getElementById('eye-icon');
            if (el.classList.contains('opacity-0')) {
                el.classList.remove('opacity-0');
                icon.className = "ph ph-eye text-2xl text-indigo-600";
            } else {
                el.classList.add('opacity-0');
                icon.className = "ph ph-eye-slash text-2xl";
            }
        }

        function toggleVoice() {
            gameState.voiceEnabled = !gameState.voiceEnabled;
            const btn = document.getElementById('voice-toggle-btn');
            if(gameState.voiceEnabled) {
                btn.innerHTML = `<i class="ph ph-speaker-high"></i> Voz: ON`;
                btn.classList.add('text-indigo-600');
                btn.classList.remove('text-slate-400');
            } else {
                synth.cancel();
                btn.innerHTML = `<i class="ph ph-speaker-slash"></i> Voz: OFF`;
                btn.classList.add('text-slate-400');
                btn.classList.remove('text-indigo-600');
            }
        }

        function drawBall() {
            if (gameState.available.length === 0) {
                alert("¡Fin de las bolas!");
                return;
            }

            // Reset UI
            document.getElementById('spoiler-answer').classList.add('opacity-0');
            document.getElementById('eye-icon').className = "ph ph-eye-slash text-2xl";
            document.getElementById('repeat-btn').disabled = false;

            // Lógica Bola
            const idx = Math.floor(Math.random() * gameState.available.length);
            const verb = gameState.available[idx];
            gameState.available.splice(idx, 1);
            gameState.currentVerb = verb;
            updateRemaining();

            // Renderizar Visual
            const display = document.getElementById('ball-display');
            const answerEl = document.getElementById('spoiler-answer');
            display.innerHTML = '';

            if (gameState.mode === 'analyst') {
                // Visual
                display.innerHTML = `
                    <div class="animate-pop flex flex-col items-center gap-4">
                        <div class="text-xs text-slate-400 font-mono uppercase tracking-widest mb-2">Descripción Gramatical</div>
                        <div class="flex flex-wrap justify-center gap-2 max-w-2xl">
                            <span class="tag-badge tag-person">${verb.person} Persona</span>
                            <span class="tag-badge tag-number">${verb.number}</span>
                        </div>
                        <div class="flex flex-wrap justify-center gap-2 max-w-3xl my-2">
                            <span class="tag-badge tag-tense text-2xl md:text-4xl py-3 px-6 shadow-md border-b-4 border-orange-200">${verb.tense}</span>
                        </div>
                        <div class="flex flex-wrap justify-center gap-2">
                            <span class="tag-badge tag-mood">${verb.mood}</span>
                        </div>
                    </div>
                `;
                answerEl.innerText = verb.conjugation;

                // Preparar Audio (Texto natural)
                // Convertir "1ª" -> "Primera", "3ª" -> "Tercera"
                const personFull = verb.person.replace("1ª", "Primera").replace("2ª", "Segunda").replace("3ª", "Tercera");
                gameState.currentSpeechText = `${personFull} Persona del ${verb.number}. ${verb.tense} de ${verb.mood}.`;

            } else {
                // Visual
                display.innerHTML = `
                    <div class="animate-pop flex flex-col items-center">
                        <div class="text-xs text-slate-400 font-mono uppercase tracking-widest mb-4">Verbo Conjugado</div>
                        <h2 class="text-5xl md:text-7xl font-bold text-indigo-700 drop-shadow-sm mb-4">${verb.conjugation}</h2>
                        <div class="bg-indigo-50 text-indigo-400 px-4 py-1 rounded-full text-sm font-bold">(${verb.infinitive})</div>
                    </div>
                `;
                answerEl.innerText = `${verb.person} ${verb.number} ${verb.tense}`;
                
                // Audio
                gameState.currentSpeechText = verb.conjugation;
            }

            addToHistory(verb);

            // Hablar
            if (gameState.voiceEnabled) {
                speakText(gameState.currentSpeechText);
            }
        }

        function speakText(text) {
            if (!synth) return;
            synth.cancel(); // Parar lo anterior
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9; // Un pelín más lento para que vocalice bien

            // Intentar buscar una voz de Google en español (suelen ser las mejores en Chrome)
            const voices = synth.getVoices();
            // Prioridad: Google Español -> Cualquier 'es-ES' -> Cualquier 'es'
            const preferredVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('es')) 
                                || voices.find(v => v.lang === 'es-ES')
                                || voices.find(v => v.lang.includes('es'));

            if (preferredVoice) {
                utterance.voice = preferredVoice;
                utterance.lang = preferredVoice.lang;
            } else {
                 utterance.lang = 'es-ES'; // Fallback
            }

            // Icon animation trigger
            const icon = document.getElementById('speaker-icon');
            utterance.onstart = () => icon.classList.add('speaking');
            utterance.onend = () => icon.classList.remove('speaking');

            synth.speak(utterance);
        }

        function repeatAudio() {
            if (gameState.currentSpeechText) {
                speakText(gameState.currentSpeechText);
            }
        }

        function addToHistory(verb) {
            const list = document.getElementById('history-list');
            const li = document.createElement('li');
            li.className = "bg-white p-3 rounded border border-slate-100 shadow-sm flex justify-between items-center text-sm hover:bg-indigo-50 transition";
            li.innerHTML = `
                <div>
                    <span class="font-bold text-slate-700 block">${verb.conjugation}</span>
                    <span class="text-xs text-slate-500">${verb.tense}</span>
                </div>
                <span class="text-xs text-indigo-300 font-mono">#${verb.id}</span>
            `;
            list.prepend(li);
        }

        // --- ALUMNO (CARTÓN) ---
        function generateStudentCard() {
            const grid = document.getElementById('bingo-grid');
            grid.innerHTML = "";
            document.getElementById('card-id').innerText = Math.floor(Math.random()*9000)+1000;

            const shuffled = [...gameState.filtered].sort(() => 0.5 - Math.random());
            const items = shuffled.slice(0, 12);

            items.forEach(verb => {
                const cell = document.createElement('div');
                cell.className = "bingo-cell rounded flex items-center justify-center p-1 h-20 md:h-24 text-center select-none";

                let text = "", subtext = "";
                
                if (gameState.mode === 'analyst') {
                    text = `<span class="font-bold text-slate-700 text-sm md:text-base leading-tight">${verb.conjugation}</span>`;
                } else {
                    text = `<span class="font-bold text-slate-700 text-xs md:text-sm leading-tight block">${verb.tense}</span>`;
                    subtext = `<span class="block text-[10px] text-slate-500 mt-1">${verb.person} ${verb.number}</span>`;
                }

                cell.innerHTML = `
                    <div class="bingo-chip"></div>
                    <div class="relative z-10 w-full">
                        ${text}
                        ${subtext}
                    </div>
                `;
                cell.onclick = () => cell.classList.toggle('marked');
                grid.appendChild(cell);
            });
        }

        // --- CONFETI ---
        function checkBingo() {
            startConfetti();
            setTimeout(() => alert("¡BINGO! Comprobemos..."), 500);
        }

        // Canvas Confetti
        const canvas = document.getElementById("confetti-canvas");
        const ctx = canvas.getContext("2d");
        let particles = [];
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        function startConfetti() {
            particles = [];
            for(let i=0; i<150; i++) {
                particles.push({
                    x: window.innerWidth/2, y: window.innerHeight/2,
                    vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20,
                    size: Math.random()*8+4, color: `hsl(${Math.random()*360},100%,50%)`, life: 100
                });
            }
            animateConfetti();
        }
        function animateConfetti() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach((p,i) => {
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.life--;
                ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size);
                if(p.life<=0) particles.splice(i,1);
            });
            if(particles.length) requestAnimationFrame(animateConfetti);
        }
    </script>
</body>
</html>
